name: Backend CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  fast-lane:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"
      STRICT_RUNTIME_TEST_BYPASS: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Fast deterministic backend lane
        run: |
          uv run --project backend pytest \
            backend/tests/test_cost_model.py \
            backend/tests/test_emissions_context.py \
            backend/tests/test_stochastic_uncertainty.py \
            backend/tests/test_scenario_compare.py \
            backend/tests/test_vehicle_custom.py \
            backend/tests/test_robust_mode.py

  strict-live-lane:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"
      STRICT_RUNTIME_TEST_BYPASS: "0"
      LIVE_SCENARIO_ALLOW_SIGNED_FALLBACK: "0"
      LIVE_FUEL_ALLOW_SIGNED_FALLBACK: "0"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Strict reason-code parity lane
        run: |
          uv run --project backend pytest \
            backend/tests/test_strict_reason_code_contract.py \
            backend/tests/test_cost_model.py::test_strict_live_url_missing_with_fallback_disabled_returns_source_unavailable \
            backend/tests/test_cost_model.py::test_strict_live_auth_failure_maps_to_auth_reason_code \
            backend/tests/test_cost_model.py::test_strict_live_stale_without_fallback_returns_source_unavailable \
            backend/tests/test_scenario_compare.py \
            backend/tests/test_stochastic_uncertainty.py \
            backend/tests/test_emissions_context.py \
            backend/tests/test_departure_profile_v2.py \
            backend/tests/test_departure_optimize.py \
            backend/tests/test_terrain_dem_coverage.py \
            backend/tests/test_terrain_fail_closed_uk.py \
            backend/tests/test_terrain_non_uk_fallback.py \
            backend/tests/test_terrain_runtime_budget.py \
            backend/tests/test_terrain_segment_grades.py \
            backend/tests/test_terrain_physics_uplift.py \
            backend/tests/test_metrics.py \
            backend/tests/test_segment_breakdown.py \
            backend/tests/test_robust_mode.py \
            backend/tests/test_vehicle_custom.py
